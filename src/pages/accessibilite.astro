---
import Layout from "../layouts/Layout.astro";
import CarteXP from "../components/CarteXP.astro";
import garesAvecActivitesData from "../assets/garesAvecActivites.json";
import * as d3 from "d3";

const garesValides = garesAvecActivitesData.filter((d) => d.nombrePOI != null);
const nombreGares = garesValides.length;
const totalPOI = d3.sum(garesValides, (d) => d.nombrePOI);
const moyennePOI = d3.mean(garesValides, (d) => d.nombrePOI);
const topGares = garesValides
    .sort((a, b) => b.nombrePOI - a.nombrePOI)
    .slice(0, 5);
---

<Layout>
    <div class="bg-base-100 min-h-screen">
        <div class="hero bg-gradient-to-r from-primary to-secondary py-16">
            <div class="hero-content text-center">
                <div class="max-w-4xl">
                    <h1 class="text-5xl font-bold text-primary-content mb-6">
                        üó∫Ô∏è Accessibilit√© touristique par le train
                    </h1>
                    <p class="text-xl text-primary-content/90 max-w-2xl mx-auto">
                        D√©couvrez le potentiel touristique accessible depuis
                        chaque gare fran√ßaise
                    </p>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-6 lg:px-20 py-12">
            <div class="alert alert-info shadow-lg mb-8">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    class="stroke-current shrink-0 w-6 h-6"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                </svg>
                <div>
                    <h3 class="font-bold text-white">√Ä propos de cette carte</h3>
                    <div class="text-sm text-white">
                        Cette carte r√©v√®le les zones o√π le train rend le
                        tourisme accessible et dense. Chaque point repr√©sente
                        une gare, sa taille et sa couleur indiquent le nombre
                        d'activit√©s touristiques accessibles dans un rayon de
                        10 km.
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div class="stats shadow bg-base-200">
                    <div class="stat">
                        <div class="stat-figure text-primary">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                                class="inline-block w-8 h-8 stroke-current"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="stat-title">Gares analys√©es</div>
                        <div class="stat-value text-primary">{nombreGares}</div>
                        <div class="stat-desc">Sur tout le territoire</div>
                    </div>
                </div>

                <div class="stats shadow bg-base-200">
                    <div class="stat">
                        <div class="stat-figure text-secondary">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                                class="inline-block w-8 h-8 stroke-current"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                                ></path>
                            </svg>
                        </div>
                        <div class="stat-title">Points d'int√©r√™t totaux</div>
                        <div class="stat-value text-secondary">
                            {totalPOI.toLocaleString("fr-FR")}
                        </div>
                        <div class="stat-desc">Activit√©s touristiques</div>
                    </div>
                </div>

                <div class="stats shadow bg-base-200">
                    <div class="stat">
                        <div class="stat-figure text-accent">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                                class="inline-block w-8 h-8 stroke-current"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                                ></path>
                            </svg>
                        </div>
                        <div class="stat-title">Moyenne par gare</div>
                        <div class="stat-value text-accent">
                            {moyennePOI?.toFixed(1)}
                        </div>
                        <div class="stat-desc">POI accessibles</div>
                    </div>
                </div>

                <div class="stats shadow bg-base-200">
                    <div class="stat">
                        <div class="stat-figure text-warning">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                                class="inline-block w-8 h-8 stroke-current"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
                                ></path>
                            </svg>
                        </div>
                        <div class="stat-title">Top gare</div>
                        <div class="stat-value text-warning text-2xl">
                            {topGares[0]?.nombrePOI}
                        </div>
                        <div class="stat-desc">{topGares[0]?.nom}</div>
                    </div>
                </div>
            </div>

            <div class="card bg-base-200 shadow-xl mb-8">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        üèÜ Top 5 des gares les plus attractives
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Gare</th>
                                    <th>R√©gion</th>
                                    <th>Points d'int√©r√™t</th>
                                </tr>
                            </thead>
                            <tbody>
                                {
                                    topGares.map((gare, index) => (
                                        <tr>
                                            <th>
                                                {index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : index + 1}
                                            </th>
                                            <td class="font-semibold">
                                                {gare.nom}
                                            </td>
                                            <td>{gare.region}</td>
                                            <td>
                                                <div class="badge badge-primary badge-lg">
                                                    {gare.nombrePOI} POI
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 shadow-2xl transition-all duration-300" id="carte-card">
                <div class="card-body">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="card-title text-3xl">
                            üó∫Ô∏è Carte interactive de l'accessibilit√© touristique
                        </h2>
                        <button
                            class="btn btn-primary btn-outline gap-2"
                            id="fullscreen-btn"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke-width="1.5"
                                stroke="currentColor"
                                class="w-5 h-5"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15"
                                ></path>
                            </svg>
                            Plein √©cran
                        </button>
                    </div>
                    <div class="divider"></div>
                    <CarteXP />
                    <div class="divider"></div>
                    <div class="alert alert-success mt-6">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="stroke-current shrink-0 h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                            ></path>
                        </svg>
                        <div>
                            <h3 class="font-bold">Comment utiliser la carte ?</h3>
                            <div class="text-sm">
                                <ul class="list-disc list-inside mt-2">
                                    <li>
                                        Utilisez la barre de recherche pour
                                        trouver une gare sp√©cifique
                                    </li>
                                    <li>
                                        Survolez les points pour voir les
                                        d√©tails (nom, r√©gion, nombre de POI)
                                    </li>
                                    <li>
                                        La taille et la couleur des points
                                        indiquent l'intensit√© touristique
                                    </li>
                                    <li>
                                        Les zones jaunes/oranges/rouges r√©v√®lent
                                        o√π le train rend le tourisme le plus
                                        accessible
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-12 text-center">
                <div class="join join-vertical lg:join-horizontal">
                    <a href="/" class="btn btn-outline join-item">
                        ‚Üê Retour √† l'accueil
                    </a>
                    <a href="/attractivite" class="btn btn-primary join-item">
                        Voir l'attractivit√© des r√©gions ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="fullscreen-overlay" class="hidden fixed inset-0 bg-black/50 z-[9998]"></div>
    <button id="close-fullscreen-floating" class="hidden btn btn-circle btn-lg btn-error fixed top-4 right-4 z-[10000]">
        ‚úï
    </button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const closeBtn = document.getElementById('close-fullscreen-floating');
            const overlay = document.getElementById('fullscreen-overlay');
            const carteCard = document.getElementById('carte-card');

            fullscreenBtn?.addEventListener('click', () => {
                carteCard?.classList.add('fixed', 'inset-0', 'w-screen', 'h-screen', 'z-[9999]', 'm-0', 'rounded-none', 'max-w-none', 'overflow-y-auto');
                carteCard?.querySelector('.card-body')?.classList.add('h-auto', 'min-h-screen', 'flex', 'flex-col');
                fullscreenBtn?.classList.add('hidden');
                overlay?.classList.remove('hidden');
                closeBtn?.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });

            const closeFullscreen = () => {
                carteCard?.classList.remove('fixed', 'inset-0', 'w-screen', 'h-screen', 'z-[9999]', 'm-0', 'rounded-none', 'max-w-none', 'overflow-y-auto');
                carteCard?.querySelector('.card-body')?.classList.remove('h-auto', 'min-h-screen', 'flex', 'flex-col');
                fullscreenBtn?.classList.remove('hidden');
                overlay?.classList.add('hidden');
                closeBtn?.classList.add('hidden');
                document.body.style.overflow = '';
            };

            closeBtn?.addEventListener('click', closeFullscreen);
            overlay?.addEventListener('click', closeFullscreen);
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && carteCard?.classList.contains('fixed')) {
                    closeFullscreen();
                }
            });
        });
    </script>
</Layout>
