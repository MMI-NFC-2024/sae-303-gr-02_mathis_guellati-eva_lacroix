---
import { onMount } from "astro/client";
---

<div class="w-full max-w-7xl mx-auto px-6 pt-6">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12">
    <div
      class="group flex gap-3 p-3 rounded-lg shadow ring-1 ring-white/10 bg-gradient-to-br from-accent to-cyan-500 text-white"
    >
      <div
        class="flex-none w-14 h-14 rounded-md bg-white/10 flex items-center justify-center text-3xl"
      >
        ğŸ¯
      </div>
      <div class="flex-1">
        <div class="text-sm font-semibold uppercase opacity-90 mb-1">
          Moyenne POI / gare
        </div>
        <div
          id="moyenne-poi"
          class="text-2xl font-extrabold leading-tight"
          aria-live="polite"
        >
          â€“
        </div>
        <div class="text-sm opacity-90 mt-1">
          Nombre moyen de points d'intÃ©rÃªt par gare
        </div>
      </div>
    </div>

    <div
      class="group flex gap-3 p-3 rounded-lg shadow ring-1 ring-white/10 bg-gradient-to-br from-success to-secondary text-white"
    >
      <div
        class="flex-none w-14 h-14 rounded-md bg-white/10 flex items-center justify-center text-3xl"
      >
        ğŸš‰
      </div>
      <div class="flex-1">
        <div class="text-sm font-semibold uppercase opacity-90 mb-1">
          Max POI
        </div>
        <div
          id="max-poi"
          class="text-2xl font-extrabold leading-tight"
          aria-live="polite"
        >
          â€“
        </div>
        <div class="text-sm opacity-90 mt-1">RÃ©gion la plus riche en POI</div>
      </div>
    </div>

    <div
      class="group flex gap-3 p-3 rounded-lg shadow ring-1 ring-white/10 bg-gradient-to-br from-rose-600/90 to-rose-500/80 text-white"
    >
      <div
        class="flex-none w-14 h-14 rounded-md bg-white/10 flex items-center justify-center text-3xl"
      >
        ğŸ“‰
      </div>
      <div class="flex-1">
        <div class="text-xs font-semibold uppercase opacity-80 mb-1">
          Min POI
        </div>
        <div
          id="min-poi"
          class="text-xl md:text-2xl font-extrabold leading-tight"
          aria-live="polite"
        >
          â€“
        </div>
        <div class="text-xs opacity-80 mt-1">RÃ©gion la moins Ã©quipÃ©e</div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-lg p-6 overflow-x-auto">
    <div id="region-plot" class="w-full"></div>
  </div>

  <p class="mt-8 mb-4 text-sm text-info italic">
    Nombre total de points dâ€™intÃ©rÃªt touristiques accessibles par rÃ©gion selon
    le nombre de gares
  </p>

  <p class="mt-6 text-sm text-info italic border-t border-base-300 pt-4">
    Sources : DonnÃ©es croisÃ©es Data Tourisme & Base Gares â€“ data.gouv.fr â€¢
    <code>regionStatsAvecNumero</code> (corrÃ©lation entre nombre de gares et POI)
  </p>

  <div class="alert alert-success bg-secondary mt-14">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="stroke-current shrink-0 h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
      ></path>
    </svg>
    <div>
      <h3 class="font-bold">Comment utiliser la carte ?</h3>
      <div class="text-sm">
        <ul class="list-disc list-inside mt-2">
          <li>Survolez un point pour voir le dÃ©tail (nombre de gares, POI, moyenne POI/gare).</li>
          <li>Les Ã©tiquettes numÃ©riques correspondent au numÃ©ro de la rÃ©gion.</li>
          <li>Utilisez la lÃ©gende et les axes pour comparer le nombre de gares et le total de POI.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  import * as Plot from "@observablehq/plot";
  import * as d3 from "d3";
  import regionStatsAvecNumero from "../assets/regionStatsAvecNumero.json";

  function createPlot(data) {
    const container = document.getElementById("region-plot");
    container.innerHTML = "";

    const plot = Plot.plot({
      width: 1000,
      height: 700,
      marginTop: 80,
      marginRight: 200,
      marginBottom: 100,
      marginLeft: 120,
      style: {
        fontSize: "13px",
        fontFamily: "'Inter', system-ui, sans-serif",
        background: "white",
      },
      x: {
        label: "ğŸš‰ Nombre de gares dans la rÃ©gion",
        grid: true,
        nice: true,
        labelOffset: 50,
      },
      y: {
        label: "ğŸ¯ Nombre total de points d'intÃ©rÃªt",
        grid: true,
        nice: true,
        labelOffset: 55,
      },
      marks: [
        Plot.ruleX(d3.range(0, 400, 50), { stroke: "#f0f0f0", strokeWidth: 1 }),
        Plot.ruleY(d3.range(0, 13000, 1000), {
          stroke: "#f0f0f0",
          strokeWidth: 1,
        }),

        Plot.line(
          [
            { x: 0, y: 0 },
            {
              x: d3.max(data, (d) => d.nombreGares) * 1.05,
              y: d3.max(data, (d) => d.totalPOI) * 1.05,
            },
          ],
          {
            x: "x",
            y: "y",
            stroke: "#e0e0e0",
            strokeWidth: 2,
            strokeDasharray: "8,4",
          }
        ),

        Plot.dot(data, {
          x: "nombreGares",
          y: "totalPOI",
          r: 12,
          fill: "#667eea",
          fillOpacity: 0.9,
          stroke: "white",
          strokeWidth: 3,
          tip: true,
          title: (d) =>
            `#${d.numero} - ${d.region}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸš‰ ${d.nombreGares} gares\nğŸ¯ ${d.totalPOI.toLocaleString("fr-FR")} POI\nâœ¨ ${d.moyennePOI.toFixed(1)} POI/gare`,
        }),

        Plot.text(data, {
          x: "nombreGares",
          y: "totalPOI",
          text: (d) => d.numero,
          fontSize: 12,
          fontWeight: "900",
          fill: "white",
          textAnchor: "middle",
        }),

        Plot.ruleX([0], { stroke: "#2c3e50", strokeWidth: 2 }),
        Plot.ruleY([0], { stroke: "#2c3e50", strokeWidth: 2 }),
      ],
    });

    container.appendChild(plot);
  }

  function updateStats(data) {
    const moyennePOI = d3.mean(data, (d) => d.moyennePOI);
    const maxPOI = d3.max(data, (d) => d.totalPOI);
    const minPOI = d3.min(data, (d) => d.totalPOI);

    const regionMax = data.find((d) => d.totalPOI === maxPOI)?.region || "â€“";
    const regionMin = data.find((d) => d.totalPOI === minPOI)?.region || "â€“";

    document.getElementById("moyenne-poi").textContent = moyennePOI.toFixed(1);
    document.getElementById("max-poi").textContent =
      `${maxPOI.toLocaleString("fr-FR")} (${regionMax})`;
    document.getElementById("min-poi").textContent =
      `${minPOI.toLocaleString("fr-FR")} (${regionMin})`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const data = regionStatsAvecNumero;
    updateStats(data);
    createPlot(data);
  });
</script>
