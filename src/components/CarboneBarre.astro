---
// ComparaisonEmissions.astro
import dataEmission from "../assets/data_emission.json";

const transports = [
    {
        nom: "Train",
        emoji: "üöÇ",
        champ: "train_empreinte_carbone_kgco2e",
        description: "Train longue distance",
    },
    {
        nom: "Autocar",
        emoji: "üöå",
        champ: "autocar_longue_distance_empreinte_carbone_kgco2e",
        description: "Autocar longue distance",
    },
    {
        nom: "Avion",
        emoji: "‚úàÔ∏è",
        champ: "avion_empreinte_carbone_kgco2e",
        description: "Vol commercial",
    },
    {
        nom: "Voiture √©lectrique",
        emoji: "üîã",
        champ: "voiture_electrique_2_2_pers_empreinte_carbone_kgco2e",
        description: "Voiture √©lectrique (2 pers.)",
    },
    {
        nom: "Voiture thermique",
        emoji: "‚õΩ",
        champ: "voiture_thermique_2_2_pers_empreinte_carbone_kgco2e",
        description: "Voiture essence/diesel (2 pers.)",
    },
];
---

<div class="w-full flex justify-center items-center">
    <div class="max-w-6xl w-full">
        <div id="comparaison-chart" class="w-full overflow-x-auto relative pt-15"></div>

        <p class="mt-4 text-sm text-gray-600 text-center italic">
            √âmissions moyennes de CO‚ÇÇ par moyen de transport (toutes routes
            confondues) | Sources : Base de donn√©es comparatives des √©missions de
            CO‚ÇÇ ‚Äì data.gouv.fr
        </p>
    </div>
</div>

<script>
    import * as Plot from "@observablehq/plot";
    import * as d3 from "d3";
    import dataEmission from "../assets/data_emission.json";

    const transportsStatic = [
        {
            nom: "Train",
            emoji: "üöÇ",
            champ: "train_empreinte_carbone_kgco2e",
            description: "Train longue distance",
        },
        {
            nom: "Autocar",
            emoji: "üöå",
            champ: "autocar_longue_distance_empreinte_carbone_kgco2e",
            description: "Autocar longue distance",
        },
        {
            nom: "Avion",
            emoji: "‚úàÔ∏è",
            champ: "avion_empreinte_carbone_kgco2e",
            description: "Vol commercial",
        },
        {
            nom: "Voiture √©lectrique",
            emoji: "üîã",
            champ: "voiture_electrique_2_2_pers_empreinte_carbone_kgco2e",
            description: "Voiture √©lectrique (2 pers.)",
        },
        {
            nom: "Voiture thermique",
            emoji: "‚õΩ",
            champ: "voiture_thermique_2_2_pers_empreinte_carbone_kgco2e",
            description: "Voiture essence/diesel (2 pers.)",
        },
    ];

    function createComparaisonChart() {
        const container = document.getElementById("comparaison-chart");
        if (!container) return;

        container.innerHTML = "";

        const donnees = transportsStatic.map((t) => {
            const valeurs = dataEmission
                .map((d) => d[t.champ])
                .filter((v) => v != null && !isNaN(v));

            const moyenne = d3.mean(valeurs);
            const min = d3.min(valeurs);
            const max = d3.max(valeurs);
            const mediane = d3.median(valeurs);

            return {
                transport: `${t.emoji} ${t.nom}`,
                emissions: moyenne || 0,
                min: min || 0,
                max: max || 0,
                mediane: mediane || 0,
                description: t.description,
                nbRoutes: valeurs.length,
            };
        });

        const minEmission = d3.min(donnees, (d) => d.emissions) || 0;
        const maxEmission = d3.max(donnees, (d) => d.emissions) || 1;

        const plot = Plot.plot({
            width: 1000,
            marginLeft: 200,
            marginRight: 100,
            marginTop: 60,
            height: 480,
            style: {
                fontSize: "15px",
                fontFamily: "system-ui, -apple-system, sans-serif",
                background: "white",
                borderRadius: "8px",
                boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
            },
            x: {
                label: "√âmissions moyennes de CO‚ÇÇ (kg CO‚ÇÇe) ‚Üí",
                tickFormat: (d) =>
                    d.toLocaleString("fr-FR", { maximumFractionDigits: 0 }),
                grid: true,
                nice: true,
                labelOffset: 50,
            },
            y: { label: null, tickPadding: 10 },
            color: {
                type: "linear",
                domain: [minEmission, maxEmission],
                range: ["#2ecc71", "#f1c40f", "#e74c3c"],
                legend: false,
            },
            marks: [
                Plot.barX(donnees, {
                    y: "transport",
                    x: "emissions",
                    fill: "emissions",
                    sort: { y: "-x" },
                    rx: 8,
                    tip: { format: { y: false, x: true, fill: false } },
                    title: (d) =>
                        `${d.transport}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚úì Moyenne: ${d.emissions.toFixed(1)} kg CO‚ÇÇe\n‚úì M√©diane: ${d.mediane.toFixed(1)} kg CO‚ÇÇe\n‚úì Min: ${d.min.toFixed(1)} kg CO‚ÇÇe\n‚úì Max: ${d.max.toFixed(1)} kg CO‚ÇÇe\n‚úì ${d.description}\n‚úì ${d.nbRoutes} routes analys√©es`,
                }),
                Plot.text(donnees, {
                    y: "transport",
                    x: "emissions",
                    text: (d) => `${d.emissions.toFixed(0)} kg`,
                    dx: 50,
                    fontSize: 14,
                    fontWeight: "700",
                    fill: (d) =>
                        d3.interpolateRgbBasis([
                            "#2ecc71",
                            "#f1c40f",
                            "#e74c3c",
                        ])(
                            (d.emissions - minEmission) /
                                (maxEmission - minEmission),
                        ),
                    textAnchor: "start",
                }),
            ],
        });

        container.appendChild(plot);

        // Cr√©er la l√©gende personnalis√©e en position absolute
        const legend = document.createElement("div");
        legend.className = "absolute top-4 left-4 bg-white/95 p-3 rounded-lg shadow-md border border-gray-200 z-10";
        legend.innerHTML = `
            <div class="text-sm font-semibold mb-2">√âmissions de CO‚ÇÇ (kg CO‚ÇÇe)</div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded" style="background: #2ecc71"></div>
                    <span class="text-xs">Faible</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded" style="background: #f1c40f"></div>
                    <span class="text-xs">Moyen</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded" style="background: #e74c3c"></div>
                    <span class="text-xs">√âlev√©</span>
                </div>
            </div>
        `;
        container.appendChild(legend);
    }

    document.addEventListener("DOMContentLoaded", () => {
        createComparaisonChart();
    });
</script>
